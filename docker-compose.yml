version: '3.8'

services:
  orquestrador-central:
    build: .
    container_name: orquestrador-central
    environment:
      # Configuração do Banco de Dados PostgreSQL (ajuste o host se necessário)
      - ConnectionStrings__DefaultConnection=Host=db-grafica;Database=bpdapi_db;Username=postgres;Password=EasdPG;Port=5432
      # Configuração do RabbitMQ
      - RabbitMQ__HostName=172.22.0.3
      - RabbitMQ__Port=5672
      - RabbitMQ__UserName=admin
      - RabbitMQ__Password=GraficaMVP2025!
      - RabbitMQ__QueueName=lote.processamento
      - RabbitMQ__QueueRetorno=lote.processamento.retorno
      - RabbitMQ__ExchangeName=graficaltda.exchange
      - RabbitMQ__DeadLetterQueue=lote.processamento.dlq
      # Configuração da AWS (substitua pelas suas credenciais reais)
      - AWS__AccessKey=key-aws
      - AWS__SecretKey=secret-aws
      - AWS__Region=us-east-1
      # Bucket S3 para arquivos processados
      - AWS__S3__OutputBucket=grafica-mvp-storage-qb1g7tq6
      - AWS__S3__OutputPrefix=processados/
      - AWS__Lambda__TimeoutSeconds=300
      - AWS__Lambda__MaxRetries=3
      # ARNs das Lambdas (substitua pelos ARNs reais após deploy)
      - AWS__Lambda__Functions__ClienteMalaDireta=arn:aws:lambda:us-east-1:444951961850:function:ProcessaMalaDireta
      - AWS__Lambda__Functions__ClienteEtiquetas=arn:aws:lambda:us-east-1:444951961850:function:ProcessamentoClienteEtiquetas
      - AWS__Lambda__Functions__ClienteCartoes=arn:aws:lambda:us-east-1:444951961850:function:ProcessamentoClienteCartoes
      - AWS__Lambda__Functions__Default=arn:aws:lambda:us-east-1:444951961850:function:ProcessamentoPCLGenerico
      # Ambiente de produção
      - ASPNETCORE_ENVIRONMENT=Production
      - TZ=America/Sao_Paulo
    restart: unless-stopped
    networks:
      - grafica-net
    volumes:
      - ./logs:/app/logs  # Montar diretório de logs para persistência
    healthcheck:
      test: ["CMD", "ps", "aux", "|", "grep", "-v", "grep", "|", "grep", "-q", "dotnet"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  grafica-net:
    external: true